<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Global Hoy</title>
  <link rel="stylesheet" href="estilos.css" />
</head>
<body>
  <!-- Menú desplegable de usuario -->
  <header>
    <h1> Global Hoy</h1>
    <div class="user-menu-container">
      <button class="user-menu-button">☰ Usuario</button>
      <div class="user-dropdown-menu">
        <button onclick="cambiarPais()"> Cambiar país</button>
        <button onclick="cambiarIdioma()"> Cambiar idioma</button>
        <button onclick="verFavoritos()">⭐ Mis favoritos</button>
        <button onclick="verHistorial()"> Mi historial</button>
        <button onclick="toggleNotificaciones()"> Notificaciones</button>
        <button onclick="cerrarSesion()"> Cerrar sesión</button>
      </div>
    </div>
  </header>

  <!-- Bienvenida -->
  <section>
    <h1>Welcome to Global Hoy</h1>
    <p>Tu fuente de noticias locales e internacionales, personalizadas por país y en tu idioma.</p>
  </section>

  <!-- Noticias Locales -->
  <section id="noticias-locales">
    <h2>Noticias en <span id="pais-actual">tu país</span></h2>
    <ul id="lista-noticias-locales"></ul>
  </section>

  <!-- Noticias internacionales (Latest News) -->
  <section>
    <h2>Latest News</h2>
    <ul id="lista-noticias"></ul>
  </section>

  <!-- Anuncios Locales -->
  <section id="anuncio-local">
    <h3>Anuncio para <span id="pais-anuncio">tu país</span></h3>
    <p id="contenido-anuncio">...</p>
  </section>

  <!-- Suscripción -->
  <section>
    <h2>Subscribe to News</h2>
    <input type="email" placeholder="Enter your email" id="email-input" />
    <button onclick="suscribirse()">Subscribe to News</button>
  </section>

  <!-- Script de detección + carga -->
  <script>
    async function detectarPais() {
      try {
        const res = await fetch('https://ipapi.co/json/');
        const data = await res.json();
        return data.country_code.toLowerCase(); // Ej: 'us', 'es', 'do'
      } catch (error) {
        console.error('Error al detectar país:', error);
        return 'us'; // por defecto
      }
    }

    async function cargarNoticiasLocales(pais) {
      document.getElementById('pais-actual').textContent = pais.toUpperCase();
      const ruta = `public/noticias/${pais}.json`;
      try {
        const res = await fetch(ruta);
        const noticias = await res.json();
        const ul = document.getElementById('lista-noticias-locales');
        noticias.forEach(noticia => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${noticia.titulo}</strong><p>${noticia.descripcion}</p>`;
          ul.appendChild(li);
        });
      } catch (e) {
        console.error('Error cargando noticias locales:', e);
      }
    }

    async function cargarNoticiasGlobales() {
      try {
        const res = await fetch('public/noticias/global.json');
        const noticias = await res.json();
        const ul = document.getElementById('lista-noticias');
        noticias.forEach(noticia => {
          const li = document.createElement('li');
          li.innerHTML = `<a href="${noticia.url}" target="_blank">${noticia.titulo}</a>`;
          ul.appendChild(li);
        });
      } catch (e) {
        console.error('Error cargando noticias globales:', e);
      }
    }

    async function cargarAnuncios(pais) {
      const anuncios = {
        do: "¡Disfruta de nuestras noticias desde República Dominicana!",
        us: "Noticias importantes para ti desde EE.UU.",
        es: "Lo último que pasa en España, aquí en Global Hoy"
      };
      document.getElementById('pais-anuncio').textContent = pais.toUpperCase();
      document.getElementById('contenido-anuncio').textContent = anuncios[pais] || "Bienvenido a Global Hoy.";
    }

    function suscribirse() {
      const email = document.getElementById('email-input').value;
      alert(`Gracias por suscribirte con: ${email}`);
      // Aquí puedes enviar el email a tu base de datos o API
    }

    function cambiarPais() {
      alert("Función para cambiar país aún no implementada.");
    }

    function cambiarIdioma() {
      alert("Función para cambiar idioma aún no implementada.");
    }

    function verFavoritos() {
      const favoritos = JSON.parse(localStorage.getItem("favoritos")) || [];
      alert("Favoritos: " + favoritos.join(", "));
    }

    function verHistorial() {
      const historial = JSON.parse(localStorage.getItem("historial")) || [];
      alert("Historial: " + historial.join(", "));
    }

    function toggleNotificaciones() {
      const estado = localStorage.getItem("notificaciones") === "on";
      localStorage.setItem("notificaciones", estado ? "off" : "on");
      alert("Notificaciones " + (estado ? "desactivadas" : "activadas"));
    }

    function cerrarSesion() {
      alert("Sesión cerrada (esto es un ejemplo).");
    }

    // Ejecutar
    (async () => {
      const pais = await detectarPais();
      await cargarNoticiasLocales(pais);
      await cargarNoticiasGlobales();
      await cargarAnuncios(pais);

      // --- Ejemplos de uso de funciones --- 
      // Guardar y obtener un idioma:
      setCookie("lang", "es");
      console.log("Idioma de la cookie:", getCookie("lang"));

      // Registrar una noticia como favorita
      guardarFavorito("noticia-123");
      console.log("Favoritos:", obtenerFavoritos());

      // Registrar visita y ver historial
      registrarVisita("noticia-123");
      console.log("Historial:", obtenerHistorial());

      // Mostrar una notificación (requiere permiso del navegador)
      // mostrarNotificacion("Bienvenido", "Gracias por visitar Global Hoy!");
    })();

    // Lógica para el menú desplegable
    document.addEventListener('DOMContentLoaded', function() {
      const menuToggle = document.querySelector('.menu-toggle');
      const menuOpciones = document.querySelector('.menu-opciones');

      if (menuToggle && menuOpciones) {
        menuToggle.addEventListener('click', function() {
          menuOpciones.classList.toggle('visible');
        });
      }
    });
  </script>
  <script src="js/cookies.js"></script>
  <script src="js/favoritos.js"></script>
  <script src="js/historial.js"></script>
  <script src="js/notificaciones.js"></script>
  <script src="js/userMenu.js"></script>
</body>
</html>